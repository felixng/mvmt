var app = angular.module('mvmt', []);

// This will cause your app to compile when Turbolinks loads a new page
// and removes the need for ng-app in the DOM
$(document).on('ready page:load', function(arguments) {
  angular.bootstrap(document.body, ['mvmt']);
});

app.controller('CategoryController',['$window', '$scope', '$rootScope', '$sce', '$http',
    function ($window, $scope, $rootScope, $sce, $http) {
        var catMenu = this;

        $rootScope.mapUrl = '';

        $rootScope.filters = [];

        $scope.updateFilter = function(category){
            
            var index = $rootScope.filters.indexOf(category);

            if (index > -1){
                console.log(index);
                $rootScope.filters.splice(index, 1);
            }
            else {
                $rootScope.filters.splice(index, 0, category);
            }
        }

        $scope.addCurrentClass = function(category){
            if (($rootScope != undefined || $rootScope.filters != undefined) && ($rootScope.filters.indexOf(category) > -1))
                return 'menu__item--current';
        }

        $scope.inList = function(category){
            if ($rootScope != undefined || $rootScope.filters != undefined)
                return ($rootScope.filters.indexOf(category) > -1);
        }

//        function performMapSearch(name){
//            $http.jsonp("https://maps.googleapis.com/maps/api/place/textsearch/json?key=AIzaSyDf0bPpbqr3E7iD7Ab2K8jgZszADG_Ir7M&query=" + name + "&callback=JSON_CALLBACK").success(function(data){
//                    console.log(data);
//                });
//
////                    .then(
////            function successCallback(response) {
////                //return response.data;
////                //console.log(data);
////                console.log(response);
////            }, function errorCallback(response) {
////                //console.log(response);
////            });
//        }
        function updatePlaceId(id, placeId){
            $http.get( "/api/v1/resources/" + id)
                    .then(function(response){
                        $http({
                            url: "/api/v1/resources/" + id,
                            dataType: 'json',
                            method: 'PUT',
                            data: {
                                id: id,
                                placeId: placeId
                            },
                            headers: {
                                "Content-Type": "application/json"
                            }
                        }).success(function(response){
                        }).error(function(error){
                            console.log(error);
                        });
                    });
        }

        $scope.MapUrl = function(name){
            return $sce.trustAsResourceUrl('https://www.google.com/maps/embed/v1/place?q=' + name + '&key=AIzaSyA3aZfa51yc-MiMjZyToarr9BqUdx1A-S4');
        }

//        $scope.setMapUrl = function(id, name, placeId){
//            if (placeId == '-1')
//            {
//                $http.get("/api/v1/resources/" + id + "/placeId")
//                        .then(function(response){
//                            console.log(response.data.status)
//                            if (response.data.status == "OK"){
//                                if (response.data && response.data.results.length > 0)
//                                {
//                                    placeId = response.data.results[0].place_id;
//                                    updatePlaceId(id, placeId);
//                                    console.log(MapUrl(placeId));
//                                    return MapUrl(placeId);
//                                }
//                            }
//                        })
//            }
//            else{
//                return MapUrl(placeId);
//            }
//        }

        $scope.updateClickThrough = function(id){
            $http.get( "/api/v1/resources/" + id)
                .then(function(response){
                    $http({
                        url: "/api/v1/resources/" + id,
                        dataType: 'json',
                        method: 'PUT',
                        data: {
                            id: id,
                            clickthrough: response.data.resource.clickthrough + 1
                        },
                        headers: {
                            "Content-Type": "application/json"
                        }
                    }).success(function(response){
                    }).error(function(error){
                        console.log(error);
                    });
            });
        }

    }
]);


